name: Generate OG Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip pillow

      - name: Run generator
        env:
          REPO_NAME: ${{ github.repository }}
          REPO_DESC: ${{ github.event.repository.description || 'Repository' }}
          REPO_OWNER: ${{ github.repository_owner }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          python3 scripts/generate_og.py \
            --output social_preview.png \
            --title "${REPO_NAME}" \
            --subtitle "${REPO_DESC}" \
            --author "${REPO_OWNER}" \
            --sha "${COMMIT_SHA}"

      - name: Show generated file
        run: ls -la social_preview.png || true

      - name: Commit and push image if changed
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@users.noreply.github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          if git status --porcelain | grep -q social_preview.png; then
            git add social_preview.png
            git commit -m "chore: update social_preview.png (auto-generated)"
            git push
            echo "Committed updated social_preview.png"
          else
            echo "No change to social_preview.png"
          fi
